<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="stylesheet" href="/css/styles.min.css">
	<meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
	<meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">
	<title th:text="${product != null ? product.name : 'Product'}">Product</title>
	<style>
		:root { --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#6b7280; --brand:#0ea5e9; --chip:#e5e7eb; --line:#eaeef4; }
		* { box-sizing: border-box; }
		html, body { height: 100%; }
		body { margin: 0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color: var(--ink); background: var(--bg); }
		.wrapper { min-height: 100%; display: flex; flex-direction: column; }
		.topbar { display:flex; align-items:center; gap:14px; padding:10px 16px; border-bottom:1px solid var(--line); background:var(--card); flex-wrap:nowrap; }
		.brand { font-weight:800; letter-spacing:.2px; }
		.nav { display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
		.nav a { color:#111827; text-decoration:none; padding:8px 10px; border-radius:8px; }
		.nav a:hover { background:#f3f4f6; }
		.top-actions { margin-left:auto; display:flex; align-items:center; gap:12px; position:relative; }
		.support-link { font-size:14px; color:var(--muted); text-decoration:none; padding:6px 10px; border-radius:8px; transition:all .2s; }
		.support-link:hover { background:#f3f4f6; color:#111827; }
		.user-btn { display:flex; align-items:center; gap:6px; cursor:pointer; color:#111827; border:1px solid var(--line); padding:6px 10px; border-radius:8px; background:#fff; white-space:nowrap; }
		.user-btn .wallet-badge { margin-left:8px; padding:4px 8px; background:#f0f9ff; border:1px solid #bae6fd; border-radius:6px; font-weight:600; color:#0369a1; font-size:12px; }
		.user-menu { position:absolute; right:0; top:48px; background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:0 10px 25px rgba(0,0,0,.08); width:200px; display:none; z-index:5; }
		.user-menu .item { display:block; padding:10px 12px; color:#111827; text-decoration:none; }
		.user-menu .item:hover { background:#f3f4f6; }
		.search { position:relative; }
		.cart { position:relative; width:28px; height:28px; display:grid; place-items:center; border:1px solid var(--line); border-radius:8px; text-decoration:none; color:#111827; }
		.cart .badge { position:absolute; top:-6px; right:-6px; background:#ef4444; color:#fff; min-width:18px; height:18px; border-radius:9px; font-size:11px; display:flex; align-items:center; justify-content:center; padding:0 5px; }
	</style>
	<style>
		.container {
			max-width: 1100px;
			margin: 20px auto;
			padding: 0 10px
		}

		.breadcrumb {
			font-size: 14px;
			color: #6b7280;
			margin-bottom: 10px
		}

		.detail {
			display: grid;
			grid-template-columns: 1.2fr 1.8fr;
			gap: 20px
		}

		.gallery {
			background: #fff;
			border: 1px solid #eaeef4;
			border-radius: 12px;
			display: grid;
			place-items: center;
			min-height: 360px
		}

		.gallery img {
			max-width: 100%;
			max-height: 100%;
			object-fit: cover;
			border-radius: 10px
		}

		.info {
			background: #fff;
			border: 1px solid #eaeef4;
			border-radius: 12px;
			padding: 16px
		}

		.title {
			font-size: 22px;
			font-weight: 700;
			margin: 0 0 6px
		}

		.price {
			font-size: 24px;
			color: #0ea5e9;
			font-weight: 800
		}

		.price-old {
			margin-left: 8px;
			color: #9ca3af;
			text-decoration: line-through
		}

		.btn {
			display: inline-block;
			padding: 10px 14px;
			border-radius: 10px;
			text-decoration: none
		}

		.btn.primary {
			background: #0ea5e9;
			color: #fff
		}

		.section {
			margin-top: 18px
		}

		.review {
			border-top: 1px solid #eaeef4;
			padding: 12px 0
		}
	</style>
</head>

<body>
	<div class="wrapper">
		<!-- Header t·ª´ layout chung -->
		<div class="topbar">
			<div class="brand">BanHangRong</div>
			<nav class="nav" aria-label="Main">
				<a href="/customer/dashboard">Home</a>
				<a href="/categories">Category</a>
				<a href="#">License Software</a>
				<a href="#">Game Keys</a>
				<a href="#">Voucher</a>
				<a href="/customer/support">Support</a>
			</nav>
			<div class="top-actions">
				<a href="/customer/support" class="support-link">Support</a>
				<div class="user" style="position:relative">
					<button id="userMenuBtn" class="user-btn" type="button" aria-haspopup="menu" aria-expanded="false">
						<span th:text="${user != null ? user.username : 'User123456'}">User123456</span>
						<span class="wallet-badge">üí∞ <span th:text="${user != null and user.balance != null ? #numbers.formatDecimal(user.balance, 0, 'COMMA', 0, 'POINT') + '‚Ç´' : '0‚Ç´'}">0‚Ç´</span></span>
						<svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M7 10l5 5 5-5" stroke="#6b7280" stroke-width="2" stroke-linecap="round"
								stroke-linejoin="round" />
						</svg>
					</button>
					<div id="userDropdown" class="user-menu" role="menu" aria-label="User menu">
					<a class="item" th:if="${user != null}" th:href="@{'/customer/profile/' + ${user.username}}" role="menuitem">My Account</a>
					<a class="item" th:unless="${user != null}" href="/login" role="menuitem">Login</a>
						<a class="item" href="/customer/notifications" role="menuitem">üîî Notifications</a>
						<a class="item" href="/customer/wishlist" role="menuitem">üíù Wishlist</a>
						<a class="item" href="/customer/reviews" role="menuitem">‚≠ê My Reviews</a>
						<a class="item" href="/customer/settings" role="menuitem">‚öôÔ∏è Settings</a>
                        <form id="topupForm" class="item" method="post" action="/wallet/vnpay/create" role="menuitem"
                            style="display:flex;gap:8px;align-items:center">
							<input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" />
							<input type="hidden" name="amount" id="topupAmountInput" />
                            <button id="openTopupModalBtn" type="button" style="all:unset;cursor:pointer;color:#0ea5e9">üí≥ Top Up
                                (VNPay)</button>
						</form>
						<a class="item" href="/orderhistory" role="menuitem">My Orders</a>
						<a class="item seller-apply" href="/seller/dashboard" role="menuitem"
							style="background:#f8fafc;border-top:1px solid #e2e8f0;color:#0ea5e9;font-weight:600;">üìà
							Become a Seller</a>
						<a class="item" href="#" role="menuitem"
							onclick="event.preventDefault(); document.getElementById('logoutForm').submit();">Logout</a>
					</div>
					<form id="logoutForm" method="post" action="/logout" style="display:none;"></form>
				</div>
				<div class="search">
					<form method="GET" action="/customer/dashboard" style="display:flex;gap:4px;">
						<input type="search" name="search" placeholder="search" aria-label="Search" th:value="${search}"
							style="height:34px;width:220px;padding:0 12px;border:1px solid var(--line);border-radius:8px;outline:none;">
						<button type="submit"
							style="padding:8px 12px;background:var(--brand);color:#fff;border:none;border-radius:8px;cursor:pointer;">üîç</button>
						<a th:if="${search != null and !search.trim().isEmpty()}" th:href="@{/customer/dashboard}"
							style="padding:8px 12px;background:#6b7280;color:#fff;text-decoration:none;border-radius:8px;display:flex;align-items:center;">‚úï</a>
					</form>
				</div>
				<a href="/cart" class="cart" title="Shopping Cart" aria-label="Shopping Cart">üõí<span class="badge"
						th:text="${cartCount}" th:if="${cartCount != null and cartCount > 0}">0</span></a>
			</div>
		</div>
		
		<div class="container">
		<div class="breadcrumb"><a href="/customer/dashboard">‚Üê Back to List</a></div>
		<div class="detail">
			<div class="gallery">
				<img th:if="${images != null and !#lists.isEmpty(images)}" th:src="${images.get(0).imageUrl}"
					alt="Image" onerror="this.onerror=null;this.src='/img/avatar_default.jpg'">
				<img th:unless="${images != null and !#lists.isEmpty(images)}" src="/img/avatar_default.jpg"
					alt="Image">
			</div>
			<div class="info">
				<div class="title" th:text="${product.name}">T√™n s·∫£n ph·∫©m</div>
				<div style="color:#6b7280">Sold: <b th:text="${product.totalSales}">0</b> ‚Ä¢ ‚≠ê <b
					th:text="${#numbers.formatDecimal(product.averageRating,1,'COMMA',1,'POINT')}">0</b></div>
				<div style="color:#374151;margin-top:4px">
					Stock: <b th:text="${product.quantity}">0</b>
					<span th:if="${product.quantity != null and product.quantity <= 0}"
						style="background:#6b7280;color:#fff;padding:4px 8px;border-radius:6px;margin-left:8px;font-size:12px;">Out of
						Stock</span>
				</div>
				<div class="section">
					<span class="price" th:if="${product.salePrice != null}"
						th:text="${#numbers.formatDecimal(product.salePrice,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span>
					<span class="price-old" th:if="${product.salePrice != null}"
						th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span>
					<span class="price" th:if="${product.salePrice == null}"
						th:text="${#numbers.formatDecimal(product.price,0,'COMMA',0,'POINT')} + '‚Ç´'">0‚Ç´</span>
				</div>
				<div class="section" style="white-space:pre-line;color:#374151" th:text="${product.description}">Product
					description...</div>
				<div class="section">
					<form method="post" action="/cart/add" style="display:flex;gap:8px;align-items:center">
						<input type="hidden" name="productId" th:value="${product.productId}" />
						<input type="number" name="quantity" min="1" value="1" th:attr="max=${product.quantity}"
							style="width:80px;padding:8px;border:1px solid #eaeef4;border-radius:8px">
					<button class="btn primary" type="submit"
						th:disabled="${product.quantity == null or product.quantity <= 0}">Add to Cart</button>
					</form>
				</div>
			</div>
		</div>

		<div class="section" style="margin-top:24px">
		<h3 style="margin:0 0 8px">Customer Reviews</h3>
		
		<!-- Vouchers -->
		<div id="voucherBox" style="margin:16px 0;padding:12px;border:1px dashed #bae6fd;background:#f0f9ff;border-radius:8px;display:none">
			<div style="font-weight:700;color:#0369a1;margin-bottom:8px">Available Vouchers</div>
			<div id="voucherList" style="display:flex;gap:8px;flex-wrap:wrap"></div>
		</div>
		
		<!-- Rating Statistics -->
		<div id="ratingStats" style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin-bottom:16px;">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
				<div>
					<span style="font-size:24px;font-weight:700;color:#111827" id="averageRatingDisplay">0.0</span>
					<span style="color:#6b7280;margin-left:8px">out of 5</span>
				</div>
				<div style="text-align:right;">
					<div style="font-size:14px;color:#6b7280">Based on</div>
					<div style="font-size:18px;font-weight:600;color:#111827" id="totalReviewsDisplay">0</div>
					<div style="font-size:14px;color:#6b7280">reviews</div>
				</div>
			</div>
			<div id="ratingDistribution" style="display:flex;flex-direction:column;gap:4px;">
				<!-- Rating distribution bars will be loaded here -->
			</div>
		</div>
		
		<div th:if="${reviews != null and !#lists.isEmpty(reviews)}">
			<div class="review" th:each="rv : ${reviews}">
				<div style="font-weight:600">‚≠ê <span th:text="${rv.rating}">5</span> ‚Ä¢ <span style="color:#6b7280"
						th:text="${#temporals.format(rv.createdAt,'dd/MM/yyyy HH:mm')}">-</span></div>
				<div th:text="${rv.comment}">N·ªôi dung b√¨nh lu·∫≠n...</div>
				<div th:if="${rv.mediaUrls != null and !rv.mediaUrls.isEmpty()}" style="margin-top:8px;">
					<div style="display:flex;gap:8px;flex-wrap:wrap;">
						<div th:each="mediaUrl : ${#strings.arraySplit(rv.mediaUrls, ',')}" style="width:60px;height:60px;border-radius:4px;overflow:hidden;border:1px solid #e5e7eb;">
							<img th:if="${!#strings.contains(mediaUrl, '.mp4') and !#strings.contains(mediaUrl, '.avi') and !#strings.contains(mediaUrl, '.mov')}" 
								 th:src="${mediaUrl}" style="width:100%;height:100%;object-fit:cover;" alt="Review image">
							<video th:if="${#strings.contains(mediaUrl, '.mp4') or #strings.contains(mediaUrl, '.avi') or #strings.contains(mediaUrl, '.mov')}" 
								   style="width:100%;height:100%;object-fit:cover;" controls>
								<source th:src="${mediaUrl}" type="video/mp4">
							</video>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div th:if="${reviews == null or #lists.isEmpty(reviews)}" style="color:#6b7280;text-align:center;padding:20px">
			No reviews yet
		</div>
		</div>
	</div>

    <!-- Top-up Modal -->
    <div id="topupModal" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:1000;">
        <div role="dialog" aria-modal="true" aria-labelledby="topupTitle" style="background:#fff;border-radius:12px;min-width:320px;max-width:92vw;padding:16px;border:1px solid #e5e7eb;box-shadow:0 10px 30px rgba(0,0,0,.18);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
                <h3 id="topupTitle" style="margin:0;font-size:18px;font-weight:700;color:#111827">Top Up (VNPay)</h3>
                <button id="closeTopupModalBtn" type="button" aria-label="Close" style="background:transparent;border:none;font-size:20px;line-height:1;cursor:pointer;color:#6b7280">√ó</button>
            </div>
            <div>
                <label for="topupAmountField" style="display:block;margin-bottom:6px;color:#374151;font-weight:600">Amount (VND)</label>
                <input id="topupAmountField" type="number" inputmode="numeric" min="20000" step="1000" placeholder="200000" style="width:100%;height:40px;padding:0 12px;border:1px solid #e5e7eb;border-radius:8px;outline:none;" />
                <div id="topupError" role="alert" style="display:none;color:#ef4444;font-size:12px;margin-top:6px;">Please enter a valid amount (>= 20,000 VND).</div>
            </div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
                <button type="button" id="cancelTopupBtn" style="padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;color:#374151;cursor:pointer;">Cancel</button>
                <button type="button" id="confirmTopupBtn" style="padding:8px 12px;border:none;border-radius:8px;background:#0ea5e9;color:#fff;cursor:pointer;">Continue</button>
            </div>
        </div>
    </div>

    <script>
		// Load rating statistics when page loads
		document.addEventListener('DOMContentLoaded', function() {
			const productId = window.location.pathname.split('/').pop();
			loadRatingStats(productId);
		});

		function loadRatingStats(productId) {
			fetch(`/api/rating/stats/${productId}`)
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						updateRatingDisplay(data);
					}
				})
				.catch(error => {
					console.error('Error loading rating stats:', error);
				});
		}

		function updateRatingDisplay(data) {
			// Update average rating
			document.getElementById('averageRatingDisplay').textContent = data.averageRating;
			
			// Update total reviews
			document.getElementById('totalReviewsDisplay').textContent = data.totalReviews;
			
			// Update rating distribution
			const distribution = data.ratingDistribution;
			const container = document.getElementById('ratingDistribution');
			
			let html = '';
			for (let i = 4; i >= 0; i--) {
				const rating = i + 1;
				const count = distribution[i] || 0;
				const percentage = data.totalReviews > 0 ? (count / data.totalReviews) * 100 : 0;
				
				html += `
					<div style="display:flex;align-items:center;gap:8px;">
						<span style="font-size:12px;color:#6b7280;min-width:20px;">${rating}</span>
						<span style="color:#fbbf24;">‚òÖ</span>
						<div style="flex:1;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden;">
							<div style="height:100%;background:#fbbf24;width:${percentage}%;transition:width 0.3s;"></div>
						</div>
						<span style="font-size:12px;color:#6b7280;min-width:30px;">${count}</span>
					</div>
				`;
			}
			
			container.innerHTML = html;
		}
	</script>
	
	<script>
		// Load vouchers for this product and render
		document.addEventListener('DOMContentLoaded', function() {
			const productId = window.location.pathname.split('/').pop();
			fetch(`/api/products-lite/${productId}/vouchers`)
				.then(r => r.ok ? r.json() : [])
				.then(list => {
					if (!Array.isArray(list) || list.length === 0) return;
					const box = document.getElementById('voucherBox');
					const wrap = document.getElementById('voucherList');
					box.style.display = 'block';
					wrap.innerHTML = '';
					list.forEach(v => {
						const chip = document.createElement('div');
						chip.style = 'background:#fff;border:1px solid #bae6fd;color:#0369a1;border-radius:8px;padding:6px 10px;display:flex;gap:8px;align-items:center';
						chip.innerHTML = `<b>${v.code}</b><span style="font-size:12px;color:#6b7280">${v.type==='PERCENT' ? ('-' + v.value + '%') : ('-' + Number(v.value||0).toLocaleString('en-US') + '‚Ç´')}</span>`;
						const btn = document.createElement('button');
						btn.textContent = 'Apply';
						btn.className = 'btn';
						btn.style = 'padding:6px 10px;background:#0ea5e9;color:#fff;border:none;border-radius:8px;cursor:pointer';
						btn.onclick = () => {
							const form = document.createElement('form');
							form.method = 'post';
							form.action = '/cart/apply-voucher';
							const inp = document.createElement('input');
							inp.type = 'hidden'; inp.name = 'code'; inp.value = v.code; form.appendChild(inp);
							const csrf = document.querySelector('meta[name="_csrf"]');
							const csrfHeader = document.querySelector('meta[name="_csrf_header"]');
							if (csrf && csrfHeader) {
								const h = document.createElement('input'); h.type='hidden'; h.name=csrfHeader.content; h.value=csrf.content; form.appendChild(h);
							}
							document.body.appendChild(form); form.submit();
						};
						chip.appendChild(btn);
						wrap.appendChild(chip);
					});
				}).catch(()=>{});
		});
		(function () {
			const btn = document.getElementById('userMenuBtn');
			const menu = document.getElementById('userDropdown');
			function close() { if (menu) { menu.style.display = 'none'; btn && btn.setAttribute('aria-expanded', 'false'); } }
			function toggle() { if (!menu) return; const show = menu.style.display !== 'block'; menu.style.display = show ? 'block' : 'none'; btn && btn.setAttribute('aria-expanded', show ? 'true' : 'false'); }
			if (btn) { btn.addEventListener('click', (e) => { e.stopPropagation(); toggle(); }); }
			document.addEventListener('click', close);
			document.addEventListener('keydown', (e) => { if (e.key === 'Escape') close(); });
		})();

        // VNPay topup modal UI
        (function() {
            const openBtn = document.getElementById('openTopupModalBtn');
            const modal = document.getElementById('topupModal');
            const closeBtn = document.getElementById('closeTopupModalBtn');
            const cancelBtn = document.getElementById('cancelTopupBtn');
            const confirmBtn = document.getElementById('confirmTopupBtn');
            const amountField = document.getElementById('topupAmountField');
            const errorEl = document.getElementById('topupError');
            const form = document.getElementById('topupForm');
            const hiddenAmount = document.getElementById('topupAmountInput');

            function openModal() {
                if (!modal) return;
                modal.style.display = 'flex';
                errorEl && (errorEl.style.display = 'none');
                if (amountField) {
                    amountField.value = '';
                    setTimeout(() => amountField.focus(), 0);
                }
                // keep dropdown open when opening modal
            }

            function closeModal() {
                if (!modal) return;
                modal.style.display = 'none';
            }

            function validateAmount(v) {
                if (v == null || v === '') return false;
                const n = Number(String(v).replace(/[^0-9]/g, ''));
                return Number.isFinite(n) && n >= 20000;
            }

            function submitTopup() {
                const raw = amountField ? amountField.value : '';
                const clean = String(raw).replace(/[^0-9]/g, '');
                if (!validateAmount(clean)) {
                    if (errorEl) errorEl.style.display = 'block';
                    if (amountField) amountField.focus();
                    return;
                }
                if (hiddenAmount) hiddenAmount.value = clean;
                closeModal();
                if (form) form.submit();
            }

            if (openBtn) openBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openModal();
            });
            if (closeBtn) closeBtn.addEventListener('click', function(e) { e.preventDefault(); closeModal(); });
            if (cancelBtn) cancelBtn.addEventListener('click', function(e) { e.preventDefault(); closeModal(); });
            if (confirmBtn) confirmBtn.addEventListener('click', function(e) { e.preventDefault(); submitTopup(); });

            // Close when clicking outside dialog
            if (modal) modal.addEventListener('click', function(e) {
                if (e.target === modal) closeModal();
            });

            // Keyboard interactions
            document.addEventListener('keydown', function(e) {
                if (modal && modal.style.display === 'flex') {
                    if (e.key === 'Escape') closeModal();
                    if (e.key === 'Enter') submitTopup();
                }
            });
        })();
	</script>
	</div>
</body>

</html>