<!-- Alternate Panels Fragment -->
<section th:fragment="panels">
  <section id="profilePanel" class="card profile-card" hidden data-panel="profile">
    <div class="header profile-header" style="flex-direction:column;align-items:center;gap:0;">
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px;width:100%;">
        <div class="avatar-edit-wrap">
          <span class="avatar lg profile-avatar-center"
            style="position:relative;display:flex;justify-content:center;align-items:center;">
            <img th:if="${user != null and !#strings.isEmpty(#strings.trim(user.avatarUrl))}" th:src="${user.avatarUrl}"
              src="/img/avatar_default.jpg" alt="Avatar" onerror="this.onerror=null;this.src='/img/avatar_default.jpg';"
              width="120" height="120" fetchpriority="high" decoding="async"
              style="max-width:120px;max-height:120px;object-fit:cover;border-radius:50%;" />
            <img th:unless="${user != null and !#strings.isEmpty(#strings.trim(user.avatarUrl))}"
              th:src="@{/img/avatar_default.jpg}" src="/img/avatar_default.jpg" alt="Avatar" width="120" height="120"
              loading="lazy" decoding="async"
              style="max-width:120px;max-height:120px;object-fit:cover;border-radius:50%;" />
            <button id="btnEditAvatar" class="avatar-edit-btn" title="Change avatar" type="button"
              style="display:none;position:absolute;bottom:6px;right:6px;background:rgba(0,0,0,0.6);border:none;border-radius:50%;padding:6px;cursor:pointer;"><i
                class="ti ti-camera" style="color:#fff;font-size:18px;"></i></button>
          </span>
        </div>
        <div class="profile-titles" style="text-align:center;">
          <h2 style="margin-bottom:2px;">Profile</h2>
          <div class="footer-note">Seller ID: <b id="profileSellerId" th:text="${sellerId}">-</b> • <span class="chip"
              th:text="${user != null ? user.userType : 'SELLER'}">SELLER</span></div>
        </div>
      </div>
    </div>
    <div class="body profile-body">
      <div class="profile-grid" style="gap:10px;">
        <div class="profile-col">
          <div class="label">Name</div>
          <div id="profile_username" class="value" style="font-weight:400;"
            th:text="${user != null and user.username != null ? user.username : '-'}">-</div>
          <div class="label">Email</div>
          <div id="profile_email" class="value" style="font-weight:400;"
            th:text="${user != null and user.email != null ? user.email : '-'}">-</div>
        </div>
        <div class="profile-col">
          <div class="label">Phone</div>
          <div id="profile_phone" class="value" style="font-weight:400;"
            th:text="${user != null and user.phoneNumber != null ? user.phoneNumber : '-'}">-</div>
          <div class="label">Gender</div>
          <div id="profile_gender" class="value" style="font-weight:400;"
            th:text="${user != null and user.gender != null ? user.gender : '-'}">-</div>
          <div class="label">Date of birth</div>
          <div id="profile_dob" class="value" style="font-weight:400;"
            th:text="${(user != null and user.birthDate != null) ? #temporals.format(user.birthDate, 'dd/MM/yyyy') : '-'}">
            -</div>
        </div>
      </div>
    </div>
    <div class="modal-actions" style="padding:12px;display:flex;gap:8px;justify-content:center;">
      <button id="btnBackToDashboard" type="button" class="btn"><i class="ti ti-arrow-left"
          style="margin-right:6px;"></i>Back</button>
      <button id="btnOpenEditProfile" type="button" class="btn primary"><i class="ti ti-edit"
          style="margin-right:6px;"></i>Edit</button>
    </div>
  </section>
  <section id="ordersPanel" class="card section-card" hidden data-panel="orders">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:180px;">Orders</div>
      <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
        <input id="ord_search" type="text" placeholder="Search (#ID / username)" class="input"
          style="min-width:160px;" />
        <input id="ord_from" type="datetime-local" class="input" />
        <input id="ord_to" type="datetime-local" class="input" />
        <button id="ord_btnFilter" type="button" class="btn">Filter</button>
        <button id="ord_btnReset" type="button" class="btn" title="Clear filters"><i class="ti ti-restore"></i></button>
        <button id="ord_btnExport" type="button" class="btn" title="Export CSV"><i class="ti ti-download"></i></button>
      </div>
    </div>
    <div class="body" style="overflow:auto;">
      <table class="table slim" style="width:100%;min-width:720px;">
        <thead>
          <tr>
            <th>ID</th>
            <th>Created At</th>
            <th>Buyer</th>
            <th>Qty (yours)</th>
            <th>Revenue (yours)</th>
          </tr>
        </thead>
        <tbody id="tbSellerOrders"></tbody>
      </table>
      <div id="pgSellerOrders" class="pager" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;"></div>
    </div>
  </section>
  <section id="keysPanel" class="card section-card" hidden data-panel="keys">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:140px;">Licenses</div>
      <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
        <select id="key_product" class="input" style="min-width:140px;">
          <option value="">Product</option>
        </select>
        <select id="key_active" class="input">
          <option value="">Status</option>
          <option value="true">Active</option>
          <option value="false">Inactive</option>
        </select>
        <input id="key_search" class="input" type="text" placeholder="Search key" style="min-width:120px;" />
        <button id="key_btnFilter" class="btn" type="button">Filter</button>
        <button id="key_btnReset" class="btn" type="button" title="Clear filters"><i class="ti ti-restore"></i></button>
      </div>
    </div>
    <div class="body" style="overflow:auto;">
      <table class="table slim" style="width:100%;min-width:780px;">
        <thead>
          <tr>
            <th data-sort="licenseId" class="sortable">ID <span class="sort-indicator"></span></th>
            <th data-sort="licenseKey" class="sortable">Key <span class="sort-indicator"></span></th>
            <th data-sort="productName" class="sortable">Product <span class="sort-indicator"></span></th>
            <th data-sort="orderId" class="sortable">Order <span class="sort-indicator"></span></th>
            <th data-sort="isActive" class="sortable">Active <span class="sort-indicator"></span></th>
            <th data-sort="expireDate" class="sortable">Expire date <span class="sort-indicator"></span></th>
            <th data-sort="activationDate" class="sortable">Activated At <span class="sort-indicator"></span></th>
            <th>Device</th>
          </tr>
        </thead>
        <tbody id="tbSellerKeys"></tbody>
      </table>
      <div id="pgSellerKeys" class="pager" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:4px;"></div>
    </div>
  </section>
  <!-- Generate Keys Panel -->
  <section id="generateKeysPanel" class="card section-card" hidden data-panel="gen-keys">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:160px;">Generate license keys</div>
    </div>
    <div class="body">
      <form id="genKeyForm" class="form">
        <div class="gen-grid">
          <!-- Left: Product list -->
          <div>
            <label class="label">Product (PUBLIC only)</label>
            <input type="hidden" id="gk_product" name="gk_product" />
            <div style="display:flex;gap:8px;margin:6px 0;align-items:center;flex-wrap:wrap;">
              <input id="gk_product_q" class="input" type="text" placeholder="Search product name" style="flex:1;min-width:200px;" />
              <button id="gk_product_search" type="button" class="btn">Search</button>
            </div>
            <div id="gk_product_table_wrap" class="panel-table-wrap">
              <table id="gk_product_table" class="table slim panel-table" style="width:100%;min-width:220px;">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- JS will render product rows here -->
                </tbody>
              </table>
            </div>
            <div id="pgGenProducts" class="pager" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;"></div>
            <div id="gk_product_selected" style="margin-top:8px;color:var(--accent);font-weight:600;"></div>
          </div>

          <!-- Center: User search and pager -->
          <div>
            <label class="label">Assign to user (optional)</label>
            <input type="hidden" id="gk_user" name="gk_user" />
            <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;align-items:center;">
              <input id="gk_user_q" class="input" type="text" placeholder="Search name or email"
                style="flex:1;min-width:160px;" />
              <select id="gk_user_type" class="input" style="width:120px;">
                <option value="">All types</option>
                <option value="CUSTOMER">Customer</option>
                <option value="SELLER">Seller</option>
                <option value="ADMIN">Admin</option>
              </select>
              <button id="gk_user_search" type="button" class="btn">Search</button>
            </div>
            <div id="gk_user_table_wrap" class="panel-table-wrap">
              <table id="gk_user_table" class="table slim panel-table" style="width:100%;min-width:360px;">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div id="pgGenUsers" class="pager" style="margin-top:8px;"></div>
            <div id="gk_user_selected" style="margin-top:8px;color:var(--accent);font-weight:600;"></div>
          </div>

          <!-- Right: Controls and action -->
          <div class="gen-controls">
            <div>
              <label class="label" for="gk_expire">Expire date</label>
              <input id="gk_expire" type="date" class="input" />
            </div>
            <div>
              <label class="label" for="gk_qty">Quantity</label>
              <input id="gk_qty" type="number" min="1" step="1" value="1" class="input" />
            </div>
            <div>
              <label class="label" for="gk_order_item">Order Item ID (optional)</label>
              <input id="gk_order_item" type="number" min="1" step="1" placeholder="e.g. 123" class="input" />
            </div>
            <div class="action-row">
              <button id="gk_submit" type="submit" class="btn primary">Generate</button>
            </div>
            <div class="footer-note" id="gk_hint">Format: PRD&lt;productId&gt;-yyyyMMdd-random. Keys are saved
              immediately. If Order Item ID is left blank and a User is selected, the system will auto-create a new order and link the generated keys to it.</div>
          </div>
        </div>
      </form>
    </div>
  </section>
  <section id="productsPanel" class="card section-card" hidden data-panel="products">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:160px;">Products</div>
      <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
        <input id="prd_search" type="text" placeholder="Search by name/description" class="input"
          style="min-width:180px;" />
        <select id="prd_category" class="input" style="min-width:160px;">
          <option value="">All categories</option>
        </select>
        <select id="prd_rating" class="input" title="Minimum rating">
          <option value="">Rating (min)</option>
          <option value="1">1+</option>
          <option value="2">2+</option>
          <option value="3">3+</option>
          <option value="4">4+</option>
          <option value="4.5">4.5+</option>
        </select>
        <select id="prd_status" class="input" title="Status">
          <option value="">All statuses</option>
          <option value="public">Public</option>
          <option value="pending">Pending</option>
          <option value="hidden">Hidden</option>
        </select>
        <select id="prd_downloads" class="input" title="Min sales/downloads">
          <option value="">Sales (min)</option>
          <option value="10">10+</option>
          <option value="50">50+</option>
          <option value="100">100+</option>
          <option value="500">500+</option>
          <option value="1000">1000+</option>
        </select>
        <button id="prd_btnFilter" type="button" class="btn">Filter</button>
        <button id="prd_btnReset" type="button" class="btn" title="Clear filters"><i class="ti ti-restore"></i></button>
      </div>
    </div>
    <div class="body" style="overflow:visible;">
      <div id="prdGrid" class="cards-grid"
        style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;align-items:stretch;">
      </div>
      <div id="pgProducts" class="pager"
        style="margin-top:12px;display:flex;flex-wrap:wrap;gap:4px;justify-content:center;"></div>
    </div>
  </section>
  <section id="vouchersPanel" class="card section-card" hidden data-panel="vouchers" aria-hidden="true">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:160px;">Vouchers</div>
      <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
        <input id="vc_search" type="text" class="input" placeholder="Search code…" style="min-width:160px;" />
        <select id="vc_product" class="input" style="min-width:180px;">
          <option value="">Select product</option>
        </select>
        <select id="vc_status" class="input" title="Status">
          <option value="">All statuses</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <!-- <option value="expired">Expired</option> -->
        </select>
        <button id="vc_btnNew" type="button" class="btn primary">New voucher</button>
        <button id="vc_btnRefresh" type="button" class="btn" title="Reload"><i class="ti ti-refresh"></i></button>
      </div>
    </div>
    <div class="body paged">
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Type</th>
              <th>Value</th>
              <th class="hide-md">Period</th>
              <th>Uses</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tbVouchers">
            <tr class="footer-note">
              <td colspan="7">Select a product to manage vouchers.</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pgVouchers"></div>
    </div>
  </section>
  <section id="profileSettingsPanel" class="card section-card" hidden data-panel="profile-settings">
    <div class="header">
      <div style="font-weight:700">Profile settings</div>
    </div>
    <div class="body">
      <div class="footer-note">Use the "Edit profile" button in the Profile panel. Profile settings contain advanced
        options (2FA, security, etc.).</div>
    </div>
  </section>
  <section id="withdrawPanel" class="card section-card" hidden data-panel="withdraw">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:160px;">Withdraw</div>
    </div>
    <div class="body">
      <div id="wd_summary" class="footer-note" style="margin-bottom:10px;">Fee: 2%. Choose bank account and amount.</div>
      <form id="wd_filters" class="form" style="margin-bottom:10px;display:grid;grid-template-columns:repeat(6, minmax(120px,1fr));gap:8px;align-items:end;">
        <div>
          <label class="label">From date</label>
          <input type="date" id="wd_from" class="input" />
        </div>
        <div>
          <label class="label">To date</label>
          <input type="date" id="wd_to" class="input" />
        </div>
        <div>
          <label class="label">Min amount</label>
          <input type="number" step="0.01" min="0" id="wd_min" class="input" placeholder="0.00" />
        </div>
        <div>
          <label class="label">Max amount</label>
          <input type="number" step="0.01" min="0" id="wd_max" class="input" placeholder="0.00" />
        </div>
        <div>
          <label class="label">Status</label>
          <select id="wd_status" class="input">
            <option value="">All</option>
            <option value="PENDING">Pending</option>
            <option value="PROCESSING">Processing</option>
            <option value="COMPLETED">Completed</option>
            <option value="FAILED">Failed</option>
          </select>
        </div>
        <div>
          <button type="button" id="wd_apply_filters" class="btn">Apply</button>
        </div>
      </form>
      <form id="wd_form" class="form">
        <div class="withdraw-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <label class="label">Bank account</label>
            <div class="bank-select-row" style="display:flex;gap:8px;align-items:center;">
              <select id="wd_bank" class="input" required style="flex:1;"></select>
              <button id="wd_add_bank" type="button" class="btn" title="Add bank account"><i class="ti ti-plus"></i></button>
            </div>
            <div class="footer-note" style="margin-top:6px;">You can add multiple bank accounts and set one as default.</div>
          </div>
          <div>
            <label class="label">Fee</label>
            <div class="value">2%</div>
          </div>
        </div>
        <div style="margin-top:10px">
          <label><input id="wd_all" type="checkbox" /> Withdraw all balance</label>
        </div>
        <div id="wd_amount_wrap" style="margin-top:8px">
          <label class="label">Amount</label>
          <input id="wd_amount" class="input" type="number" min="0" step="0.01" placeholder="Enter amount" />
          <div id="wd_net_preview" class="footer-note" style="margin-top:6px;">Net after fee: -</div>
        </div>
        <div style="margin-top:12px">
          <button id="wd_submit" type="submit" class="btn primary">Create withdrawal</button>
        </div>
      </form>
      <div class="table-wrap" style="margin-top:16px">
        <table class="table slim">
          <thead><tr><th>ID</th><th>Time</th><th>Amount</th><th>Fee</th><th>Net</th><th>Status</th></tr></thead>
          <tbody id="wd_history"></tbody>
        </table>
        <div id="wd_pager" class="pager" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;"></div>
      </div>
    </div>
  </section>
  <!-- Check Key Panel -->
  <section id="checkKeyPanel" class="card section-card" hidden data-panel="check-key">
    <div class="header" style="align-items:center;gap:12px;flex-wrap:wrap;">
      <div style="font-weight:700;flex:1;min-width:160px;">Check key</div>
      <div class="filter-row" style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
        <input id="ck_key" type="text" class="input" placeholder="Enter license key" style="min-width:200px;" />
        <button id="ck_btnCheck" type="button" class="btn primary">Check</button>
        <button id="ck_btnReset" type="button" class="btn" title="Clear"><i class="ti ti-restore"></i></button>
      </div>
    </div>
    <div class="body" style="overflow:auto;">
      <div id="ck_result" style="margin-bottom:12px;display:none;">
        <h3 style="margin:0 0 6px 0;">Key details</h3>
        <div style="display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;">
          <div id="ck_details" class="panel-details footer-note" style="flex:1;min-width:220px;">No key checked yet.</div>
          <div id="ck_product_display" style="min-width:220px;max-width:320px;"></div>
          <div id="ck_device_box" style="min-width:200px;max-width:320px;padding:10px;border-radius:8px;border:1px solid var(--muted);background:var(--surface);">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
              <i class="fa fa-desktop" aria-hidden="true" style="font-size:18px;color:var(--muted)"></i>
              <div style="font-weight:700;">Device</div>
            </div>
            <div id="ck_device_info" class="footer-note" style="line-height:1.45;display:flex;flex-direction:column;gap:6px;">
              <div><i class="fa fa-id-badge" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>ID:</strong> <span id="ck_device_id">-</span></div>
              <div><i class="fa fa-user" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Host:</strong> <span id="ck_device_host">-</span></div>
              <div><i class="fa fa-window-maximize" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Platform:</strong> <span id="ck_device_platform">-</span></div>
              <div><i class="fa fa-microchip" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>CPU:</strong> <span id="ck_device_cpu">-</span></div>
              <div><i class="fa fa-layer-group" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Cores:</strong> <span id="ck_device_cores">-</span></div>
              <div><i class="fa fa-memory" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Memory:</strong> <span id="ck_device_memory">-</span></div>
              <div style="display:flex;align-items:center;gap:6px;">
                <i class="fa fa-folder-open" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i>
                <strong style="flex:0 0 auto;">Path:</strong>
                <a id="ck_device_path" href="#" target="_blank" style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:inline-block;vertical-align:middle;">-</a>
              </div>
              <div><i class="fa fa-clock" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Last used:</strong> <span id="ck_device_lastUsed">-</span></div>
              <div><i class="fa fa-calendar-check" aria-hidden="true" style="width:18px;display:inline-block;color:var(--muted)"></i> <strong>Activated:</strong> <span id="ck_device_activated">-</span></div>
            </div>
          </div>
        </div>
      </div>
      <div id="ck_history_wrap" style="display:none;margin-top:8px;">
        <h4 style="margin:0 0 6px 0;">Usage history</h4>
        <div class="table-wrap">
          <table class="table slim" style="width:100%;min-width:600px;">
            <thead>
              <tr>
                <th>Time</th>
                <th>Action</th>
                <th>User</th>
                <th>IP</th>
                <th>Device</th>
              </tr>
            </thead>
            <tbody id="ck_history"></tbody>
          </table>
        </div>
        <div id="ck_history_pager" class="pager" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center;"></div>
      </div>
      <div id="ck_helper" class="footer-note" style="margin-top:10px;">Enter a license key to view its status and usage history. This lookup does not navigate away from the dashboard.</div>
      <!-- <script>
        (function(){
          window.setDevicePath = function(fullUrl, maxLen = 48){
            try{
              const a = document.getElementById('ck_device_path');
              if(!a) return;
              if(!fullUrl){ a.href = '#'; a.title = ''; a.textContent = '-'; return; }
              a.href = fullUrl;
              a.title = fullUrl;
              if(fullUrl.length <= maxLen){ a.textContent = fullUrl; return; }
              // shorten middle
              const keep = Math.max(8, Math.floor((maxLen - 3) / 2));
              const start = fullUrl.slice(0, keep);
              const end = fullUrl.slice(fullUrl.length - keep);
              a.textContent = start + '...' + end;
            }catch(e){ console && console.warn && console.warn('setDevicePath error', e); }
          };
        })();
      </script> -->
    </div>
  </section>