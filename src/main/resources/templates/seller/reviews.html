<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đánh giá - Bán Hàng Rong</title>
    <link rel="stylesheet" href="/css/style.min.css">
    <link rel="stylesheet" href="/css/seller-dashboard.css">
</head>
<body class="loading">
<!-- Page Loader -->
<div id="appLoader">
    <div class="loader-core">
        <div class="orbital">
            <div class="orbit orbit-a"><span></span></div>
            <div class="orbit orbit-b"><span></span></div>
            <div class="orbit orbit-c"><span></span></div>
            <div class="rings">
                <div class="ring r1"></div>
                <div class="ring r2"></div>
                <div class="ring r3"></div>
            </div>
            <div class="nucleus">
                <img th:src="@{/img/kua654ms.png}" src="/img/kua654ms.png" alt="Logo" class="loader-logo"
                     data-logo-light="/img/kua654ms.png" data-logo-dark="/img/white.png" />
            </div>
        </div>
        <div class="load-text" data-loader-text>Đang khởi tạo...</div>
        <div class="progress-wrap">
            <div class="progress-bar" data-loader-progress></div>
        </div>
        <div class="load-tip" data-loader-tip></div>
    </div>
</div>

<div class="page">
    <!-- Sidebar (giữ nguyên hoàn toàn từ template của bạn) -->
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Header -->
        <header class="title" data-block="dashboard-header">
            <span class="accent"></span>
            <h1>Quản lý Đánh giá & Phản hồi</h1>
            <span class="chip">Seller ID: <b id="sellerId" th:text="${sellerId}"></b></span>
        </header>

        <!-- KPI Cards -->
        <section class="grid kpi" data-block="kpi">
            <div class="card" data-kpi="reviews-total">
                <div class="label">Tổng đánh giá</div>
                <div class="value"><span data-count th:attr="data-count=${allReviews.size()}" th:text="${allReviews.size()}">0</span></div>
                <div class="delta pill">Tất cả đánh giá nhận được</div>
                <div class="orb one"></div><div class="orb two"></div>
            </div>
            <div class="card" data-kpi="reviews-unanswered">
                <div class="label">Chờ phản hồi</div>
                <div class="value"><span data-count th:attr="data-count=${unansweredCount}" th:text="${unansweredCount}">0</span></div>
                <div class="delta pill warn">Cần xử lý ngay</div>
            </div>
            <div class="card" data-kpi="reviews-answered">
                <div class="label">Đã phản hồi</div>
                <div class="value"><span data-count th:attr="data-count=${allReviews.size() - unansweredCount}" th:text="${allReviews.size() - unansweredCount}">0</span></div>
                <div class="delta pill good">Đã hoàn thành</div>
            </div>
        </section>

        <!-- Tab Navigation -->
        <div style="display: flex; gap: 8px; margin: 24px 0 16px 0; border-bottom: 1px solid var(--border); padding-bottom: 8px;">
            <a href="#" class="tab active" data-tab="unanswered" style="padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: var(--muted); text-decoration: none; display: flex; align-items: center; gap: 8px; background: color-mix(in oklab, var(--accent) 12%, var(--bg-elev)); color: var(--text);">
                <i class="ti ti-clock"></i>
                Chờ phản hồi
                <span class="badge bg-warning" th:text="${unansweredCount}">0</span>
            </a>
            <a href="#" class="tab" data-tab="all" style="padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; color: var(--muted); text-decoration: none; display: flex; align-items: center; gap: 8px;">
                <i class="ti ti-list"></i>
                Tất cả đánh giá
            </a>
        </div>

        <!-- Tab: Chờ phản hồi -->
        <div class="tab-content active" id="unanswered">
            <div th:if="${unansweredReviews.isEmpty()}" class="empty-state" style="text-align: center; padding: 40px 20px; color: var(--muted);">
                <i class="ti ti-check" style="font-size: 48px; opacity: 0.5;"></i>
                <h5>Không có đánh giá nào chờ phản hồi</h5>
                <p>Tất cả đánh giá đã được phản hồi!</p>
            </div>

            <div th:each="review : ${unansweredReviews}" class="card" style="margin-bottom: 16px;">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--muted); font-size: 14px;">Review #<span th:text="${review.reviewId}">ID</span></h4>
                            <div style="color: #ffc107; margin-bottom: 8px;">
                                <i th:each="i : ${#numbers.sequence(1, review.rating)}" class="ti ti-star-filled"></i>
                                <i th:each="i : ${#numbers.sequence(review.rating + 1, 5)}" class="ti ti-star"></i>
                            </div>
                        </div>
                        <span class="badge bg-warning">Chờ phản hồi</span>
                    </div>

                    <div style="margin-bottom: 12px; line-height: 1.5;" th:text="${review.comment}">Comment content</div>

                    <div style="color: var(--muted); font-size: 12px; margin-bottom: 12px;">
                        User ID: <span th:text="${review.userId}">User</span> •
                        Product ID: <span th:text="${review.productId}">Product</span> •
                        <span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </div>

                    <!-- Response form -->
                    <form th:attr="data-reviewid=${review.reviewId}" class="response-form" style="margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                                <textarea placeholder="Nhập phản hồi của bạn..." rows="3" maxlength="1000" required
                                          style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: color-mix(in oklab, var(--bg) 94%, transparent); color: var(--text); resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <button class="btn primary" type="submit" style="margin-top: 8px;">
                            <i class="ti ti-send"></i> Gửi phản hồi
                        </button>
                    </form>
                </div>
            </div>

            <!-- Pagination for Unanswered Reviews -->
            <div th:if="${unansweredReviewsPage.totalPages > 1}" class="pagination-wrapper" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; flex-wrap: wrap;">
                <a th:href="@{/seller/reviews(unansweredPage=${unansweredReviewsPage.number - 1}, page=${currentPage})}"
                   th:classappend="${unansweredReviewsPage.first} ? 'disabled' : ''"
                   class="pagination-btn"
                   style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px;">
                    <i class="ti ti-chevron-left"></i> Trước
                </a>

                <div style="display: flex; gap: 4px;">
                    <th:block th:each="i : ${#numbers.sequence(0, unansweredReviewsPage.totalPages - 1)}">
                        <a th:if="${i == unansweredReviewsPage.number || (i >= unansweredReviewsPage.number - 2 && i <= unansweredReviewsPage.number + 2) || i == 0 || i == unansweredReviewsPage.totalPages - 1}"
                           th:href="@{/seller/reviews(unansweredPage=${i}, page=${currentPage})}"
                           th:text="${i + 1}"
                           th:classappend="${i == unansweredReviewsPage.number} ? 'active' : ''"
                           class="pagination-btn"
                           style="padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; min-width: 40px; text-align: center;">
                        </a>
                        <span th:if="${i == 1 && unansweredReviewsPage.number > 3}" style="padding: 8px; color: var(--muted);">...</span>
                        <span th:if="${i == unansweredReviewsPage.totalPages - 2 && unansweredReviewsPage.number < unansweredReviewsPage.totalPages - 4}" style="padding: 8px; color: var(--muted);">...</span>
                    </th:block>
                </div>

                <a th:href="@{/seller/reviews(unansweredPage=${unansweredReviewsPage.number + 1}, page=${currentPage})}"
                   th:classappend="${unansweredReviewsPage.last} ? 'disabled' : ''"
                   class="pagination-btn"
                   style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px;">
                    Sau <i class="ti ti-chevron-right"></i>
                </a>

                <span style="padding: 8px 12px; color: var(--muted); font-size: 14px;">
                    Trang <b th:text="${unansweredReviewsPage.number + 1}">1</b> / <b th:text="${unansweredReviewsPage.totalPages}">1</b>
                    (<span th:text="${unansweredReviewsPage.totalElements}">0</span> đánh giá)
                </span>
            </div>
        </div>

        <!-- Tab: Tất cả đánh giá -->
        <div class="tab-content" id="all" style="display: none;">
            <div th:if="${allReviews.isEmpty()}" class="empty-state" style="text-align: center; padding: 40px 20px; color: var(--muted);">
                <i class="ti ti-message-circle" style="font-size: 48px; opacity: 0.5;"></i>
                <h5>Chưa có đánh giá nào</h5>
                <p>Khách hàng sẽ đánh giá sau khi mua sản phẩm của bạn.</p>
            </div>

            <div th:each="review : ${allReviews}" class="card" style="margin-bottom: 16px;">
                <div class="card-body">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--muted); font-size: 14px;">Review #<span th:text="${review.reviewId}">ID</span> - Product ID: <span th:text="${review.productId}">Product</span></h4>
                            <div style="color: #ffc107; margin-bottom: 8px;">
                                <i th:each="i : ${#numbers.sequence(1, review.rating)}" class="ti ti-star-filled"></i>
                                <i th:each="i : ${#numbers.sequence(review.rating + 1, 5)}" class="ti ti-star"></i>
                            </div>
                        </div>
                        <span th:if="${review.sellerResponse != null}" class="badge bg-success">Đã phản hồi</span>
                        <span th:if="${review.sellerResponse == null}" class="badge bg-warning">Chờ phản hồi</span>
                    </div>

                    <div style="margin-bottom: 12px; line-height: 1.5;" th:text="${review.comment}">Comment content</div>

                    <div style="color: var(--muted); font-size: 12px; margin-bottom: 12px;">
                        User ID: <span th:text="${review.userId}">User</span> •
                        <span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                    </div>

                    <!-- Seller response -->
                    <div th:if="${review.sellerResponse != null}" style="background: color-mix(in oklab, var(--bg-soft) 96%, transparent); border-left: 4px solid var(--accent); padding: 12px; border-radius: 0 8px 8px 0; margin-top: 12px;">
                        <strong>Phản hồi của bạn:</strong>
                        <p style="margin: 8px 0;" th:text="${review.sellerResponse}">Seller response</p>
                        <div style="color: var(--muted); font-size: 12px;" th:if="${review.sellerResponseAt != null}">
                            Phản hồi lúc: <span th:text="${#temporals.format(review.sellerResponseAt, 'dd/MM/yyyy HH:mm')}">Response date</span>
                        </div>
                    </div>

                    <!-- Response form (if not responded) -->
                    <form th:if="${review.sellerResponse == null}" th:attr="data-reviewid=${review.reviewId}" class="response-form" style="margin-top: 12px;">
                        <div style="margin-bottom: 12px;">
                                <textarea placeholder="Nhập phản hồi của bạn..." rows="3" maxlength="1000" required
                                          style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; background: color-mix(in oklab, var(--bg) 94%, transparent); color: var(--text); resize: vertical; font-family: inherit;"></textarea>
                        </div>
                        <button class="btn primary" type="submit" style="margin-top: 8px;">
                            <i class="ti ti-send"></i> Gửi phản hồi
                        </button>
                    </form>
                </div>
            </div>

            <!-- Pagination for All Reviews -->
            <div th:if="${allReviewsPage.totalPages > 1}" class="pagination-wrapper" style="display: flex; justify-content: center; align-items: center; gap: 8px; margin-top: 24px; flex-wrap: wrap;">
                <a th:href="@{/seller/reviews(page=${allReviewsPage.number - 1}, unansweredPage=${currentUnansweredPage})}"
                   th:classappend="${allReviewsPage.first} ? 'disabled' : ''"
                   class="pagination-btn"
                   style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px;">
                    <i class="ti ti-chevron-left"></i> Trước
                </a>

                <div style="display: flex; gap: 4px;">
                    <th:block th:each="i : ${#numbers.sequence(0, allReviewsPage.totalPages - 1)}">
                        <a th:if="${i == allReviewsPage.number || (i >= allReviewsPage.number - 2 && i <= allReviewsPage.number + 2) || i == 0 || i == allReviewsPage.totalPages - 1}"
                           th:href="@{/seller/reviews(page=${i}, unansweredPage=${currentUnansweredPage})}"
                           th:text="${i + 1}"
                           th:classappend="${i == allReviewsPage.number} ? 'active' : ''"
                           class="pagination-btn"
                           style="padding: 8px 14px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; min-width: 40px; text-align: center;">
                        </a>
                        <span th:if="${i == 1 && allReviewsPage.number > 3}" style="padding: 8px; color: var(--muted);">...</span>
                        <span th:if="${i == allReviewsPage.totalPages - 2 && allReviewsPage.number < allReviewsPage.totalPages - 4}" style="padding: 8px; color: var(--muted);">...</span>
                    </th:block>
                </div>

                <a th:href="@{/seller/reviews(page=${allReviewsPage.number + 1}, unansweredPage=${currentUnansweredPage})}"
                   th:classappend="${allReviewsPage.last} ? 'disabled' : ''"
                   class="pagination-btn"
                   style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-elev); color: var(--text); text-decoration: none; transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 4px;">
                    Sau <i class="ti ti-chevron-right"></i>
                </a>

                <span style="padding: 8px 12px; color: var(--muted); font-size: 14px;">
                    Trang <b th:text="${allReviewsPage.number + 1}">1</b> / <b th:text="${allReviewsPage.totalPages}">1</b>
                    (<span th:text="${allReviewsPage.totalElements}">0</span> đánh giá)
                </span>
            </div>
        </div>
    </main>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<style>
    .pagination-btn {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: var(--bg-elev);
        color: var(--text);
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        cursor: pointer;
    }

    .pagination-btn:hover:not(.disabled) {
        background: color-mix(in oklab, var(--accent) 12%, var(--bg-elev));
        border-color: var(--accent);
        transform: translateY(-1px);
    }

    .pagination-btn.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
        font-weight: 600;
    }

    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
    }

    .pagination-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 24px;
        flex-wrap: wrap;
    }
</style>

<script src="/js/seller-dashboard.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab functionality
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();

                // Remove active class from all tabs and contents
                tabs.forEach(t => {
                    t.style.background = '';
                    t.style.color = 'var(--muted)';
                });
                tabContents.forEach(c => c.style.display = 'none');

                // Add active class to clicked tab and corresponding content
                this.style.background = 'color-mix(in oklab, var(--accent) 12%, var(--bg-elev))';
                this.style.color = 'var(--text)';
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).style.display = 'block';
            });
        });

        // Handle response forms
        const responseForms = document.querySelectorAll('.response-form');

        responseForms.forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const reviewId = this.getAttribute('data-reviewid');
                const textarea = this.querySelector('textarea');
                const response = textarea.value.trim();

                if (!response) {
                    if (typeof showToast === 'function') {
                        showToast('Vui lòng nhập nội dung phản hồi', 'error', 3000);
                    }
                    return;
                }

                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="ti ti-loader"></i> Đang gửi...';
                submitBtn.disabled = true;

                // API call to submit response
                fetch('/seller/reviews/respond/' + reviewId, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        response: response
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            if (typeof showToast === 'function') {
                                showToast('Đã gửi phản hồi thành công!', 'success', 3000);
                            }

                            // Update UI without reloading
                            const reviewCard = this.closest('.card');
                            const badge = reviewCard.querySelector('.badge');

                            if (badge) {
                                badge.textContent = 'Đã phản hồi';
                                badge.className = 'badge bg-success';
                            }

                            // Add response box
                            const responseBox = document.createElement('div');
                            responseBox.style.background = 'color-mix(in oklab, var(--bg-soft) 96%, transparent)';
                            responseBox.style.borderLeft = '4px solid var(--accent)';
                            responseBox.style.padding = '12px';
                            responseBox.style.borderRadius = '0 8px 8px 0';
                            responseBox.style.marginTop = '12px';
                            responseBox.innerHTML = `
                                <strong>Phản hồi của bạn:</strong>
                                <p style="margin: 8px 0;">${response}</p>
                                <div style="color: var(--muted); font-size: 12px;">
                                    Phản hồi lúc: ${new Date().toLocaleString('vi-VN')}
                                </div>
                            `;

                            // Remove the form and add response box
                            this.remove();
                            reviewCard.querySelector('.card-body').appendChild(responseBox);

                            // Update unanswered count in sidebar and tabs
                            updateUnansweredCount(-1);

                        } else {
                            if (typeof showToast === 'function') {
                                showToast('Lỗi: ' + data.message, 'error', 4000);
                            }
                            submitBtn.innerHTML = originalText;
                            submitBtn.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        if (typeof showToast === 'function') {
                            showToast('Lỗi gửi phản hồi', 'error', 4000);
                        }
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    });
            });
        });

        // Function to update unanswered count
        function updateUnansweredCount(change) {
            // Update sidebar badge
            const sidebarBadge = document.getElementById('unansweredReviewCount');
            if (sidebarBadge) {
                const currentCount = parseInt(sidebarBadge.textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                sidebarBadge.textContent = newCount;

                // Hide badge if count is 0
                if (newCount === 0) {
                    sidebarBadge.style.display = 'none';
                } else {
                    sidebarBadge.style.display = 'inline-block';
                }
            }

            // Update tab badge
            const tabBadge = document.querySelector('.tab[data-tab="unanswered"] .badge');
            if (tabBadge) {
                const currentCount = parseInt(tabBadge.textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                tabBadge.textContent = newCount;

                // Hide badge if count is 0
                if (newCount === 0) {
                    tabBadge.style.display = 'none';
                } else {
                    tabBadge.style.display = 'inline-block';
                }
            }

            // Update KPI cards
            const unansweredKpi = document.querySelector('[data-kpi="reviews-unanswered"] .value span');
            if (unansweredKpi) {
                const currentCount = parseInt(unansweredKpi.textContent) || 0;
                const newCount = Math.max(0, currentCount + change);
                unansweredKpi.textContent = newCount;
                unansweredKpi.setAttribute('data-count', newCount);
            }

            const respondedKpi = document.querySelector('[data-kpi="reviews-answered"] .value span');
            if (respondedKpi) {
                const totalReviews = parseInt(document.querySelector('[data-kpi="reviews-total"] .value span').textContent) || 0;
                const unanswered = parseInt(document.querySelector('[data-kpi="reviews-unanswered"] .value span').textContent) || 0;
                const newResponded = totalReviews - unanswered;
                respondedKpi.textContent = newResponded;
                respondedKpi.setAttribute('data-count', newResponded);
            }

            // Trigger count animation if available
            if (typeof animateCount === 'function') {
                document.querySelectorAll('[data-count]').forEach(animateCount);
            }
        }
    });
</script>
</body>
</html>