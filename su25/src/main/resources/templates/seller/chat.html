<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat H·ªó Tr·ª£ Kh√°ch H√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .chat-container {
            display: flex;
            height: 70vh;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .chat-sidebar {
            width: 300px;
            border-right: 1px solid #ddd;
            background: #f8f9fa;
            overflow-y: auto;
        }
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background: #007bff;
            color: white;
        }
        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f0f2f5;
        }
        .chat-input {
            padding: 15px;
            border-top: 1px solid #ddd;
            background: white;
        }
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
        }
        .message.sent {
            background: #007bff;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background: white;
            border: 1px solid #ddd;
        }
        .room-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .room-item:hover {
            background: #e9ecef;
        }
        .room-item.active {
            background: #007bff;
            color: white;
        }
        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            margin-left: auto;
        }
    </style>
</head>
<body>
<div class="container-fluid mt-4">
    <h2>üí¨ Chat H·ªó Tr·ª£ Kh√°ch H√†ng</h2>

    <div class="chat-container">
        <!-- Sidebar v·ªõi danh s√°ch ph√≤ng chat -->
        <div class="chat-sidebar">
            <div class="p-3 border-bottom">
                <h5>Ph√≤ng Chat</h5>
                <div class="text-muted small" id="totalUnread">
                    <span th:text="${totalUnread}">0</span> tin nh·∫Øn ch∆∞a ƒë·ªçc
                </div>
            </div>
            <div id="chatRooms">
                <!-- Danh s√°ch ph√≤ng chat -->
                <div th:each="room : ${chatRooms}" class="room-item" th:attr="data-roomid=${room.roomId}">
                    <div class="d-flex align-items-center">
                        <strong th:text="${room.customer.username}">Customer</strong>
                    </div>
                    <small class="text-muted" th:if="${room.product != null}" th:text="${room.product.name}">Product Name</small>
                    <small class="text-muted" th:text="${#temporals.format(room.updatedAt, 'dd/MM HH:mm')}">01/01 12:00</small>
                </div>

                <!-- S·ª¨A L·ªñI: D√πng isEmpty() thay v√¨ .empty -->
                <div th:if="${chatRooms.isEmpty()}" class="p-3 text-center text-muted">
                    <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
                    <p>Ch∆∞a c√≥ ph√≤ng chat n√†o</p>
                    <small>T·∫°o d·ªØ li·ªáu test trong database</small>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-main">
            <div class="chat-header">
                <h5 id="currentRoomTitle">Ch·ªçn m·ªôt ph√≤ng chat ƒë·ªÉ b·∫Øt ƒë·∫ßu</h5>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted mt-5">
                    <i class="bi bi-chat-dots" style="font-size: 48px;"></i>
                    <p>Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ xem tin nh·∫Øn</p>
                </div>
            </div>

            <div class="chat-input" id="chatInput" style="display: none;">
                <div class="input-group">
                    <input type="text" class="form-control" id="messageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." maxlength="1000">
                    <button class="btn btn-primary" id="sendMessageBtn">
                        <i class="bi bi-send"></i> G·ª≠i
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test instructions -->
    <div class="mt-4 card">
        <div class="card-header bg-light">
            <h6>üß™ H∆∞·ªõng d·∫´n Test</h6>
        </div>
        <div class="card-body">
            <p class="small">ƒê·ªÉ test h·ªá th·ªëng chat, ch·∫°y c√°c l·ªánh SQL sau trong database:</p>
            <code class="small d-block p-2 bg-dark text-white rounded">
                -- T·∫°o ph√≤ng chat<br>
                INSERT INTO chat_rooms (seller_id, customer_id, product_id) VALUES (1, 2, 1);<br><br>
                -- T·∫°o tin nh·∫Øn test<br>
                INSERT INTO chat_messages (room_id, sender_id, content) VALUES <br>
                (1, 2, 'Xin ch√†o, t√¥i mu·ªën h·ªèi v·ªÅ s·∫£n ph·∫©m'),<br>
                (1, 1, 'Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨?');
            </code>
            <a href="/seller/dashboard" class="btn btn-secondary mt-2">
                <i class="bi bi-arrow-left"></i> Quay l·∫°i Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    // JavaScript ƒë∆°n gi·∫£n ƒë·ªÉ test
    document.addEventListener('DOMContentLoaded', function() {
        const roomItems = document.querySelectorAll('.room-item');

        roomItems.forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                roomItems.forEach(i => i.classList.remove('active'));
                // Add active class to clicked item
                this.classList.add('active');

                const roomId = this.getAttribute('data-roomid');
                const customerName = this.querySelector('strong').textContent;

                // Update UI
                document.getElementById('currentRoomTitle').textContent = 'Chat v·ªõi ' + customerName;
                document.getElementById('chatInput').style.display = 'block';

                // Clear messages and show loading
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML =
                    '<div class="text-center text-muted mt-5">' +
                    '<div class="spinner-border" role="status">' +
                    '<span class="visually-hidden">Loading...</span>' +
                    '</div>' +
                    '<p>ƒêang t·∫£i tin nh·∫Øn...</p>' +
                    '</div>';

                // Load messages via AJAX
                fetch('/seller/chat/api/messages/' + roomId)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(messages => {
                        displayMessages(messages);
                    })
                    .catch(error => {
                        console.error('Error loading messages:', error);
                        messagesContainer.innerHTML =
                            '<div class="alert alert-danger">' +
                            'L·ªói t·∫£i tin nh·∫Øn: ' + error.message +
                            '</div>';
                    });
            });
        });

        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = '';

            if (messages.length === 0) {
                container.innerHTML =
                    '<div class="text-center text-muted mt-5">' +
                    '<p>Ch∆∞a c√≥ tin nh·∫Øn n√†o</p>' +
                    '<small>H√£y b·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!</small>' +
                    '</div>';
                return;
            }

            messages.forEach(function(message) {
                const messageEl = document.createElement('div');
                const isSeller = message.sender.userId === 1; // Assuming seller ID is 1

                messageEl.className = 'message ' + (isSeller ? 'sent' : 'received');
                messageEl.innerHTML =
                    '<div class="message-content">' + escapeHtml(message.content) + '</div>' +
                    '<small class="message-time">' + new Date(message.createdAt).toLocaleTimeString() + '</small>';
                container.appendChild(messageEl);
            });

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Send message functionality
        var sendMessageBtn = document.getElementById('sendMessageBtn');
        var messageInput = document.getElementById('messageInput');

        if (sendMessageBtn) {
            sendMessageBtn.addEventListener('click', sendMessage);
        }

        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            var input = document.getElementById('messageInput');
            var content = input.value.trim();
            var roomItem = document.querySelector('.room-item.active');

            if (!content || !roomItem) return;

            var roomId = roomItem.getAttribute('data-roomid');

            fetch('/seller/chat/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    roomId: roomId,
                    senderId: 1, // Seller ID
                    content: content,
                    messageType: 'TEXT'
                })
            })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.success) {
                        input.value = '';
                        // Reload messages
                        var customerName = roomItem.querySelector('strong').textContent;
                        roomItem.click(); // Simulate click to reload messages
                    } else {
                        alert('L·ªói g·ª≠i tin nh·∫Øn: ' + data.message);
                    }
                })
                .catch(function(error) {
                    console.error('Error sending message:', error);
                    alert('L·ªói g·ª≠i tin nh·∫Øn');
                });
        }
    });
</script>
</body>
</html>